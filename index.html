<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AI Calibrator</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.18.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@0.4.0/dist/speech-commands.min.js"></script>

    <style>
        body { background: #111; color: #fff; font-family: monospace; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        
        /* THE VISUALIZER BARS */
        .bar-container { width: 100%; margin-bottom: 10px; }
        .bar-label { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 2px; }
        .bar-bg { width: 100%; height: 20px; background: #333; border-radius: 4px; overflow: hidden; }
        .bar-fill { height: 100%; background: #555; width: 0%; transition: width 0.1s linear; }
        
        /* Highlight the target word */
        .target .bar-fill { background: #1a73e8; } 
        .target .bar-label { color: #8ab4f8; font-weight: bold; }

        /* Trigger Indicator */
        #trigger-status {
            margin-top: 20px;
            padding: 15px;
            border: 2px solid #555;
            width: 80%;
            text-align: center;
            font-size: 20px;
            color: #555;
            border-radius: 10px;
        }
        #trigger-status.active {
            border-color: #0f0;
            color: #0f0;
            background: #002200;
            box-shadow: 0 0 15px #0f0;
        }

        button { padding: 15px 30px; font-size: 18px; border-radius: 50px; background: #fff; color: #000; border: none; margin-bottom: 20px; margin-top: 20px; }
        
        #loading { color: orange; font-size: 18px; margin-bottom: 20px; }
    </style>
</head>
<body>

    <h2 style="color: #888;">Voice Confidence Meter</h2>
    <div id="loading">Loading AI Model... (Please Wait)</div>
    
    <button id="btn" disabled>Start Listening</button>

    <!-- Visualizers for top words -->
    <div class="bar-container target">
        <div class="bar-label"><span>YES (Target)</span><span id="score-yes">0%</span></div>
        <div class="bar-bg"><div class="bar-fill" id="bar-yes"></div></div>
    </div>
    
    <div class="bar-container">
        <div class="bar-label"><span>NO</span><span id="score-no">0%</span></div>
        <div class="bar-bg"><div class="bar-fill" id="bar-no"></div></div>
    </div>

    <div class="bar-container">
        <div class="bar-label"><span>BACKGROUND NOISE</span><span id="score-bg">0%</span></div>
        <div class="bar-bg"><div class="bar-fill" id="bar-bg"></div></div>
    </div>

    <div id="trigger-status">CARD HIDDEN</div>

    <script>
        const btn = document.getElementById('btn');
        const loading = document.getElementById('loading');
        const triggerBox = document.getElementById('trigger-status');
        let recognizer;
        let isListening = false;

        // LOAD MODEL
        async function app() {
            try {
                recognizer = speechCommands.create('BROWSER_FFT');
                await recognizer.ensureModelLoaded();
                
                loading.innerText = "Model Ready.";
                loading.style.color = "#888";
                btn.disabled = false;
                btn.style.backgroundColor = "#1a73e8"; // Blue
                btn.style.color = "#fff";
            } catch(e) {
                loading.innerText = "Error: " + e.message;
                loading.style.color = "red";
            }
        }
        app();

        // START/STOP
        btn.addEventListener('click', () => {
            if (isListening) {
                stop();
            } else {
                start();
            }
        });

        function start() {
            isListening = true;
            btn.innerText = "Stop Listening";
            btn.style.backgroundColor = "#d93025"; // Red
            
            // WE LOWER THE THRESHOLD TO 0.00 so we see EVERYTHING
            recognizer.listen(result => {
                const words = recognizer.wordLabels();
                const scores = result.scores; // Array of probabilities
                
                // Get Specific Scores
                const yesIndex = words.indexOf('yes');
                const noIndex = words.indexOf('no');
                const bgIndex = words.indexOf('background_noise');

                const yesScore = scores[yesIndex];
                const noScore = scores[noIndex];
                const bgScore = scores[bgIndex];

                // Update UI Bars
                updateBar('yes', yesScore);
                updateBar('no', noScore);
                updateBar('bg', bgScore);

                // CHECK TRIGGER (Set to 0.75 for this test)
                if (yesScore > 0.75) {
                    activateTrigger();
                } else {
                    deactivateTrigger();
                }

            }, {
                includeSpectrogram: false,
                probabilityThreshold: 0.00, // We want to see all data
                overlapFactor: 0.50
            });
        }

        function stop() {
            isListening = false;
            recognizer.stopListening();
            btn.innerText = "Start Listening";
            btn.style.backgroundColor = "#1a73e8";
        }

        function updateBar(id, score) {
            const percentage = (score * 100).toFixed(1) + "%";
            document.getElementById(`score-${id}`).innerText = percentage;
            document.getElementById(`bar-${id}`).style.width = percentage;
        }

        function activateTrigger() {
            triggerBox.innerText = "CARD REVEALED!";
            triggerBox.classList.add('active');
        }

        function deactivateTrigger() {
            // Only reset if we aren't currently triggering
            // In a real trick, we wouldn't reset, but for testing we do
             setTimeout(() => {
                 triggerBox.classList.remove('active');
                 triggerBox.innerText = "CARD HIDDEN";
             }, 1000);
        }

    </script>
</body>
</html>

